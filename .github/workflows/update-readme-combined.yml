name: Update README & Auto-Translate

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - ".github/README_PARTS/*"
      - ".github/README_PARTS/5.MAIN_Article_*.md"
      - ".github/README_PARTS/0.Language.md"

permissions:
  contents: write
  pull-requests: write
  models: read

env:
  BRANCH_PREFIX: update/readme-

jobs:
  # -------------------
  # Подготовка
  # -------------------
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  # -------------------
  # Настройка git-автора
  # -------------------
  setup-git:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

  # -------------------
  # Сборка основного README
  # -------------------
  compile-readme:
    needs: setup-git
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build README.md
        run: |
          PARTS=".github/README_PARTS"
          OUTPUT="README.md"

          LANGUAGE="$PARTS/0.Language.md"
          HEADER="$PARTS/1.HEADER.md"
          DESCRIPTION="$PARTS/2.DESCRIPTION.md"
          DONATION="$PARTS/3.DONATION.md"
          NAV="$PARTS/4.NAV.md"
          MAIN_Header="$PARTS/5.MAIN_Header.md"
          FOOTER="$PARTS/6.FOOTER.md"

          MAIN_ARTICLES=$(ls "$PARTS"/5.MAIN_Article_*.md 2>/dev/null | sort -V || true)

          for f in "$HEADER" "$DESCRIPTION" "$DONATION" "$NAV" "$MAIN_Header" "$FOOTER"; do
            [[ -f "$f" ]] || { echo "Missing required file: $f"; exit 1; }
          done

          > "$OUTPUT"
          cat "$LANGUAGE" >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$HEADER"   >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$DESCRIPTION" >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$DONATION" >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$NAV"      >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$MAIN_Header" >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"

          for art in $MAIN_ARTICLES; do
            cat "$art" >> "$OUTPUT"
            echo -e "\n\n" >> "$OUTPUT"
          done

          cat "$FOOTER"   >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$LANGUAGE" >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"

      - name: Upload compiled README
        uses: actions/upload-artifact@v4
        with:
          name: compiled-readme
          path: README.md
          retention-days: 1

  # -------------------
  # Pull Request для основного README
  # -------------------
  create-pr-readme:
    needs: compile-readme
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: compiled-readme
          path: .

      - name: Verify README.md exists
        run: |
          if [[ -f README.md ]]; then
            echo "README.md найден"
          else
            echo "README.md НЕ НАЙДЕН!"
            exit 1
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate README (auto)"
          title: "chore: regenerate README (auto)"
          body: |
            Автоматическая пересборка README.md из частей
            Run: ${{ github.run_id }}
          branch: ${{ env.BRANCH_PREFIX }}readme-${{ github.run_id }}
          base: main
          delete-branch: true
          labels: automated, documentation
          add-paths: README.md

  # -------------------
  # Перевод: матрица языков
  # -------------------
  translate:
    needs: create-pr-readme
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - language: "spanish"
            file: "README.es.md"
          - language: "chinese"
            file: "README.zh.md"
          - language: "english"
            file: "README.en.md"
    name: Translate to ${{ matrix.language }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: compiled-readme
          path: .

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install openai tiktoken

      - name: Translate with chunking
        id: translate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'EOF'
          import os, openai, tiktoken

          client = openai.OpenAI(
              base_url="https://models.inference.ai.azure.com/",
              api_key=os.environ["GITHUB_TOKEN"]
          )
          encoding = tiktoken.encoding_for_model("gpt-4o")

          def count_tokens(text):
              return len(encoding.encode(text))

          def translate_chunk(chunk, target):
              prompt = f"""Технические термины используйте только на английском. Не переводите блоки кода или URL.

          Translate the following text to {target.capitalize()}:

          {chunk}"""
              resp = client.chat.completions.create(
                  model="gpt-4o",
                  messages=[{"role": "user", "content": prompt}]
              )
              return resp.choices[0].message.content

          with open("README.md", "r", encoding="utf-8") as f:
              text = f.read()

          paragraphs = text.split("\n\n")
          chunks, current, tokens = [], [], 0
          MAX = 6000

          for p in paragraphs:
              p_tokens = count_tokens(p) + 2
              if tokens + p_tokens > MAX and current:
                  chunks.append(translate_chunk("\n\n".join(current), "${{ matrix.language }}"))
                  current, tokens = [], 0
              current.append(p)
              tokens += p_tokens

          if current:
              chunks.append(translate_chunk("\n\n".join(current), "${{ matrix.language }}"))

          translated = "\n\n".join(chunks)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as out:
              print("translated-text<<EOF", file=out)
              print(translated, file=out)
              print("EOF", file=out)
          EOF

      - name: Save translation
        run: |
          mkdir -p LanguageReadme
          echo "${{ steps.translate.outputs.translated-text }}" > LanguageReadme/${{ matrix.file }}

      - name: Fix media paths
        run: |
          sed -i 's|\./media/|../media/|g' LanguageReadme/${{ matrix.file }}
          sed -i -E 's|(\.\./)+media/|../media/|g' LanguageReadme/${{ matrix.file }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.file }}
          path: LanguageReadme/${{ matrix.file }}

  # -------------------
  # Генерация индекса языков
  # -------------------
  generate-language-file:
    needs: translate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: LanguageReadme
          merge-multiple: true

      - name: Build 0.Language.md
        run: |
          mkdir -p .github/README_PARTS
          OUTPUT=".github/README_PARTS/0.Language.md"

          echo '<p align="center">' > "$OUTPUT"
          echo '  <strong>-------></strong>' >> "$OUTPUT"
          echo '  <a href="/README.md">Русский</a> |' >> "$OUTPUT"

          for file in LanguageReadme/README.*.md; do
            [[ -f "$file" ]] || continue
            filename=$(basename "$file")
            lang="${filename#README.}"
            lang="${lang%.md}"
            case "$lang" in
              en) name="English" ;;
              es) name="Spanish" ;;
              zh) name="Chinese" ;;
              *)  name="$lang" ;;
            esac
            echo "  <a href=\"/LanguageReadme/$filename\">$name</a> |" >> "$OUTPUT"
          done

          echo '  <strong><-------</strong>' >> "$OUTPUT"
          echo '</p>' >> "$OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: LanguageIndex
          path: .github/README_PARTS/0.Language.md

  # -------------------
  # Pull Request для переводов и индекса
  # -------------------
  create-pr-translations:
    needs: generate-language-file
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Restore structure
        run: |
          mkdir -p LanguageReadme .github/README_PARTS
          find artifacts -name "README.*.md" -exec cp {} LanguageReadme/ \;
          find artifacts -name "0.Language.md" -exec cp {} .github/README_PARTS/ \;

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update translations (auto)"
          title: "chore: update translations (auto)"
          body: |
            Обновлены переводы
            Обновлён индекс языков
            Run: ${{ github.run_id }}
          branch: ${{ env.BRANCH_PREFIX }}translations-${{ github.run_id }}
          base: main
          delete-branch: true
          labels: automated, translation
          add-paths: |
            LanguageReadme/README*.md
            .github/README_PARTS/0.Language.md